function Point(a,b){this.x=a||0,this.y=b||0}var el=document.getElementById("myCanvas"),ctx=el.getContext("2d"),Shape=Base.extend({prevX:0,prevY:0,constructor:function(a,b,c,d,e){this.x=a,this.y=b,this.color=c,this.lineWidth=d,this.name=e},draw:function(){}}),Square=Shape.extend({width:0,height:0,fillColor:"init",draw:function(){ctx.beginPath(),ctx.lineWidth=this.lineWidth,ctx.strokeStyle="#"+this.color,"init"!==this.fillColor&&(ctx.fillStyle="#"+this.fillColor,ctx.fillRect(this.x,this.y,this.width,this.height)),ctx.strokeRect(this.x,this.y,this.width,this.height),ctx.closePath()},updateMe:function(a,b){this.width=a-this.x,this.height=b-this.y,this.draw()},containsMouse:function(a,b){return containPointSquareObject(this,a,b)},dragMe:function(a,b){updateXandYcoordinatesForShape(this,a,b),this.draw()},updateFillColor:function(a){console.log("square"),this.fillColor=a}}),Eraser=Shape.extend({width:0,height:0,draw:function(){ctx.beginPath(),ctx.fillStyle="#"+this.color,ctx.fillRect(this.x,this.y,this.width,this.height),ctx.closePath()},updateMe:function(a,b){this.width=a-this.x,this.height=b-this.y,this.draw()},containsMouse:function(){return!1},dragMe:function(){}}),Circle=Shape.extend({radius:0,fillColor:"init",draw:function(){ctx.beginPath(),ctx.arc(this.x,this.y,this.radius,0,2*Math.PI,!1),ctx.lineWidth=this.lineWidth,ctx.strokeStyle="#"+this.color,"init"!==this.fillColor&&(ctx.fillStyle="#"+this.fillColor,ctx.fill()),ctx.stroke(),ctx.closePath()},updateMe:function(a,b){var c=a-this.x,d=b-this.y;this.radius=Math.sqrt(Math.pow(Math.abs(c),2)+Math.pow(Math.abs(d),2)),this.draw()},containsMouse:function(a,b){var c=Math.sqrt(Math.pow(Math.abs(this.x-a),2)+Math.pow(Math.abs(this.y-b),2));return c<=this.radius?!0:!1},dragMe:function(a,b){updateXandYcoordinatesForShape(this,a,b),this.draw()},updateFillColor:function(a){this.fillColor=a}}),Line=Shape.extend({endX:0,endY:0,draw:function(){ctx.beginPath(),ctx.strokeStyle="#"+this.color,ctx.lineWidth=this.lineWidth,ctx.moveTo(this.x,this.y),ctx.lineTo(this.endX,this.endY),ctx.stroke(),ctx.closePath()},updateMe:function(a,b){this.endX=a,this.endY=b,this.draw()},containsMouse:function(a,b){return checkIfLineContainsMouse(a,b,this.x,this.y,this.endX,this.endY)},dragMe:function(a,b){updateXandYcoordinatesForShape(this,a,b),this.draw()}}),Arrow=Shape.extend({endX:0,endY:0,draw:function(){ctx.beginPath(),ctx.strokeStyle="#"+this.color,ctx.lineWidth=this.lineWidth,ctx.fillStyle="#"+this.color,ctx.moveTo(this.x,this.y),ctx.lineTo(this.endX,this.endY),ctx.lineTo(this.endX-25,this.endY-25),ctx.arcTo(this.endX,this.endY,this.endX-25,this.endY+25,35),ctx.lineTo(this.endX,this.endY),ctx.fill(),ctx.stroke(),ctx.closePath()},updateMe:function(a,b){this.endX=a,this.endY=b,this.draw()},containsMouse:function(a,b){return checkIfLineContainsMouse(a,b,this.x,this.y,this.endX,this.endY)},dragMe:function(a,b){updateXandYcoordinatesForShape(this,a,b),this.draw()}}),Arrow2=Shape.extend({endX:0,endY:0,draw:function(){ctx.beginPath(),ctx.strokeStyle="#"+this.color,ctx.lineWidth=this.lineWidth,ctx.fillStyle="#"+this.color,ctx.moveTo(this.x,this.y),ctx.lineTo(this.endX,this.endY),ctx.lineTo(this.endX+25,this.endY+25),ctx.arcTo(this.endX,this.endY,this.endX+25,this.endY-25,35),ctx.lineTo(this.endX,this.endY),ctx.fill(),ctx.stroke(),ctx.closePath()},updateMe:function(a,b){this.endX=a,this.endY=b,this.draw()},containsMouse:function(a,b){return checkIfLineContainsMouse(a,b,this.x,this.y,this.endX,this.endY)},dragMe:function(a,b){updateXandYcoordinatesForShape(this,a,b),this.draw()}}),Pen=Shape.extend({pointX:0,pointY:0,constructor:function(a,b,c,d){ctx.moveTo(a,b),this.base(a,b,c,d),this.cords=[]},penDraw:function(){ctx.lineJoin=ctx.lineCap="round",ctx.lineTo(this.pointX,this.pointY),ctx.lineWidth=this.lineWidth,ctx.strokeStyle="#"+this.color,ctx.stroke(),ctx.clearRect(0,0,el.width,el.height),drawing.drawAllShapes()},draw:function(){ctx.beginPath(),ctx.moveTo(this.x,this.y),ctx.lineJoin=ctx.lineCap="round",ctx.lineWidth=this.lineWidth,ctx.strokeStyle="#"+this.color;for(var a=0;a<this.cords.length;a++)ctx.lineTo(this.cords[a].x,this.cords[a].y),ctx.stroke();ctx.closePath()},updateMe:function(a,b){this.cords.push(new Point(a,b)),this.pointX=a,this.pointY=b,this.penDraw()},containsMouse:function(a,b){for(var c=!1,d=0;d<this.cords.length;d++)this.cords[d].x>a-15&&this.cords[d].x<a+15&&this.cords[d].y>b-15&&this.cords[d].y<b+15&&(c=!0);return c},dragMe:function(a,b){var c=a-this.prevX,d=b-this.prevY;this.prevX=a,this.prevY=b,this.x+=c,this.y+=d;for(var e=0;e<this.cords.length;e++)this.cords[e].x+=c,this.cords[e].y+=d;this.draw()}}),Text_Area=Shape.extend({width:0,height:0,constructor:function(a,b,c,d){this.base(a,b,c,d),this.fontSize=drawing.fontSize,this.fontName=drawing.fontName,this.fontType=drawing.fontType,this.inputText=drawing.inputText,this.name="text_area"},draw:function(){ctx.fillStyle="#"+this.color,ctx.font=this.fontType+" "+this.fontSize+"pt "+this.fontName,ctx.fillText(this.inputText,this.x,this.y)},containsMouse:function(a,b){return this.width=this.inputText.length*this.fontSize,this.height=-this.fontSize,containPointSquareObject(this,a,b)},dragMe:function(a,b){updateXandYcoordinatesForShape(this,a,b),this.draw()},updateText:function(a){this.inputText=a,this.draw()}}),uploadImage=Shape.extend({url:"",img:null,width:0,height:0,draw:function(){this.img.src=this.url,ctx.drawImage(this.img,this.x,this.y)},updateMe:function(a,b){this.url=a,this.img=b},containsMouse:function(a,b){return containPointSquareObject(this,a,b)},dragMe:function(a,b){updateXandYcoordinatesForShape(this,a,b),this.draw()}});$("#myCanvas").mousedown(function(a){var b=a.pageX-this.offsetLeft,c=a.pageY-this.offsetTop;if("fill"===drawing.currentTool){var d=drawing.getShape(b,c);null!==d&&(d instanceof Square||d instanceof Circle)&&(d.updateFillColor(drawing.penColor),cleanCanvas())}else if("edit"===drawing.currentTool){var e=drawing.getShape(b,c);null!==e&&(updateTextProperties(e,drawing.fontSize,drawing.fontName,drawing.fontType),cleanCanvas())}else if("border"===drawing.currentTool){var d=drawing.getShape(b,c);null!==d&&(updateColorAndLineWidth(d,drawing.penColor,drawing.lineWidth),cleanCanvas())}else if("select"!==drawing.currentTool){drawing.textBoxX=a.pageX,drawing.textBoxY=a.pageY,drawing.isDrawing=!0;var f=shapeFactory(b,c);drawing.shapes.push(f)}else drawing.isMoving=!0,drawing.moveMe=drawing.getShape(b,c),null!==drawing.moveMe&&(drawing.moveMe.prevX=b),null!==drawing.moveMe&&(drawing.moveMe.prevY=c)}),$("#myCanvas").mouseup(function(){drawing.isDrawing=!1,drawing.isMoving=!1}),$("#myCanvas").mousemove(function(a){var b=a.pageX-this.offsetLeft,c=a.pageY-this.offsetTop;$("#status").html(b+", "+c),"eraser"===drawing.currentTool?$(this).css("cursor","url(gfx/erase.png), auto"):"pen"===drawing.currentTool?$(this).css("cursor","url(gfx/mouseIcon.png), auto"):"fill"===drawing.currentTool?$(this).css("cursor","url(gfx/Actions-fill-color-icon2.png), auto"):this.style.cursor="pointer",drawing.isDrawing?(drawing.currectObject()instanceof Pen||ctx.clearRect(0,0,el.width,el.height),drawing.currectObject()instanceof Text_Area||drawing.currectObject().updateMe(b,c),drawing.currectObject()instanceof Pen||drawing.drawAllShapes()):drawing.isMoving&&null!==drawing.moveMe&&(ctx.clearRect(0,0,el.width,el.height),drawing.moveMe.dragMe(b,c),drawing.drawAllShapes())});var cleanCanvas=function(){ctx.clearRect(0,0,el.width,el.height),drawing.drawAllShapes()},drawing={shapes:[],cache:[],lineWidth:5,isDrawing:!1,currentTool:"pen",penColor:"000000",eraserColor:"ffffff",fillColor:"ffffff",undoRedo:"NULL",fontSize:11,fontName:"Verdana",fontType:"",inputText:"",moveMe:null,isMoving:!1,textBoxX:0,textBoxY:0,drawAllShapes:function(){for(var a=0;a<drawing.shapes.length;a++)drawing.shapes[a].draw()},currectObject:function(){return drawing.shapes[drawing.shapes.length-1]},getShape:function(a,b){for(var c=drawing.shapes.length-1,d=c;d>=0;d--)if(drawing.shapes[d].containsMouse(a,b))return drawing.shapes[d];return null}};$("#fontSize").change(function(){drawing.fontSize=$("#fontSize").val(),console.log("your font size is "+drawing.fontSize)}),$("#selectFont").change(function(){drawing.fontName=$("#selectFont").val(),console.log("your font is "+drawing.fontName)}),$(".fontSettings").click(function(){drawing.fontType=$(this).data("tool"),console.log("The font type is "+drawing.fontType)}),$(".colorLink").click(function(){drawing.penColor=$(this).data("colorvalue"),console.log("The tool color is "+drawing.penColor)}),$("#colorSelector").ColorPicker({color:"#7d3d7d",onSubmit:function(a,b){drawing.penColor=b,console.log("The tool color according to color picker is "+drawing.penColor)}}),$(".toolLink").click(function(){drawing.currentTool=$(this).data("tool"),console.log("You are drawing with "+drawing.currentTool)}),$("#lineThickness").change(function(){drawing.lineWidth=$("#lineThickness").val(),console.log("your line width is "+drawing.lineWidth)}),$("#newFile").click(function(){confirm("Are you sure you want to start a new painting?")&&location.reload()}),$(".testLink").click(function(){if(drawing.undoRedo=$(this).data("undochoice"),console.log($(this).data("undochoice")),"undo"===drawing.undoRedo&&0!==drawing.shapes.length){var a=drawing.shapes.pop();drawing.cache.push(a)}else if("redo"===drawing.undoRedo&&0!==drawing.cache.length){var b=drawing.cache.pop();drawing.shapes.push(b)}cleanCanvas()}),$("#fileURL").change(function(a){var b=new FileReader;b.onload=function(a){var b=new Image;b.onload=function(){ctx.drawImage(b,10,10),drawing.shapes.push(new uploadImage(10,10,"null","null")),drawing.currectObject().width=b.width,drawing.currectObject().height=b.height,drawing.currectObject().updateMe(c,b)};var c=a.target.result;b.src=c},b.readAsDataURL(a.target.files[0])}),$("#download").click(function(){var a=el.toDataURL();document.getElementById("download").src=a}),$("#textInput").keyup(function(a){13===a.which&&(drawing.inputText=$("#textInput").val(),console.log(drawing.inputText),drawing.currectObject().updateText(drawing.inputText),$("#textcontainer").hide(),$("#textInput").val(""))});var button=document.getElementById("download");button.addEventListener("click",function(){var a=el.toDataURL("image/png");button.href=a});var shapeFactory=function(a,b){return"square"===drawing.currentTool?new Square(a,b,drawing.penColor,drawing.lineWidth,"square"):"pen"===drawing.currentTool?new Pen(a,b,drawing.penColor,drawing.lineWidth,"pen"):"eraser"===drawing.currentTool?new Eraser(a,b,drawing.eraserColor,drawing.lineWidth,"eraser"):"text_area"===drawing.currentTool?($("#textcontainer").css({top:drawing.textBoxY,left:drawing.textBoxX}).show(),new Text_Area(a,b,drawing.penColor,drawing.lineWidth,"text_area")):"line"===drawing.currentTool?new Line(a,b,drawing.penColor,drawing.lineWidth,"line"):"circle"===drawing.currentTool?new Circle(a,b,drawing.penColor,drawing.lineWidth,"circle"):"arrow2"===drawing.currentTool?new Arrow2(a,b,drawing.penColor,drawing.lineWidth,"arrow2"):"arrow"===drawing.currentTool?new Arrow(a,b,drawing.penColor,drawing.lineWidth,"arrow"):void 0},distance=function(a,b,c,d){var e=c-a,f=d-b;return Math.sqrt(e*e+f*f)},checkIfLineContainsMouse=function(a,b,c,d,e,f){var g=distance(c,d,a,b)+distance(e,f,a,b),h=distance(c,d,e,f);return h=h.toFixed(0),g=g.toFixed(0),g===h?!0:!1},updateColorAndLineWidth=function(a,b,c){a.lineWidth=c,a.color=b},updateXandYcoordinatesForShape=function(a,b,c){var d=b-a.prevX,e=c-a.prevY;a.prevX=b,a.prevY=c,a.x+=d,a.y+=e,(a instanceof Line||a instanceof Arrow||a instanceof Arrow2)&&(a.endX+=d),(a instanceof Line||a instanceof Arrow||a instanceof Arrow2)&&(a.endY+=e)},containPointSquareObject=function(a,b,c){var d=!1,e=a.x+a.width,f=a.y+a.height;return a.x<e&&a.y<f?a.x<=b&&e>=b&&a.y<=c&&f>=c&&(d=!0):a.x<e&&a.y>f?a.x<=b&&e>=b&&a.y>=c&&c>=f&&(d=!0):a.x>e&&a.y<f?a.x>=b&&b>=e&&a.y<=c&&f>=c&&(d=!0):a.x>e&&a.y>f&&a.x>=b&&b>=e&&a.y>=c&&c>=f&&(d=!0),d},updateTextProperties=function(a,b,c,d){a.fontSize=b,a.fontName=c,a.fontType=d},name="",stringifiedArray="";$("#save").click(function(){stringifiedArray=JSON.stringify(drawing.shapes),console.log(drawing.shapes),name=prompt("Name file");var a={user:"telma13",name:name,content:stringifiedArray,template:!1};console.log("ýtti á save"),$.ajax({type:"POST",contentType:"application/json; charset=utf-8",url:"http://whiteboard.apphb.com/Home/Save",data:a,dataType:"jsonp",crossDomain:!0,success:function(){console.log("náði að save-a")},error:function(){}})}),$("#upload").click(function(){var a={user:"telma13",template:!1};$("#listBoxContainer").show(),console.log("ýtti á upload"),$.ajax({type:"GET",contentType:"application/json; charset=utf-8",url:"http://whiteboard.apphb.com/Home/GetList",data:a,dataType:"jsonp",crossDomain:!0,success:function(a){console.log("success i upload"),console.log(a),console.log(a.length);for(var b=0;b<a.length;b++)$("#sltbox").append('<option value="'+a[b].ID+'">'+a[b].WhiteboardTitle+"</option>")},error:function(){}})}),$(document).ready(function(){$("#sltbox").on("change",function(){var a=this.value,b={user:"telma13",id:a};$.ajax({type:"GET",contentType:"application/json; charset=utf-8",url:"http://whiteboard.apphb.com/Home/GetWhiteboard",data:b,dataType:"jsonp",crossDomain:!0,success:function(a){console.log(" í GetWhiteboard"),console.log(a);var b=JSON.parse(a.WhiteboardContents);console.log(b);for(var c=0;c<b.length;c++)"square"===b[c].name?(drawing.shapes.push(new Square(b[c].x,b[c].y,b[c].color,b[c].lineWidth,"square")),drawing.currectObject().width=b[c].width,drawing.currectObject().height=b[c].height):"circle"===b[c].name?(drawing.shapes.push(new Circle(b[c].x,b[c].y,b[c].color,b[c].lineWidth,"circle")),drawing.currectObject().radius=b[c].radius):"line"===b[c].name?(drawing.shapes.push(new Line(b[c].x,b[c].y,b[c].color,b[c].lineWidth,"line")),drawing.currectObject().endX=b[c].endX,drawing.currectObject().endY=b[c].endY):"arrow"===b[c].name?(drawing.shapes.push(new Arrow(b[c].x,b[c].y,b[c].color,b[c].lineWidth,"arrow")),drawing.currectObject().endX=b[c].endX,drawing.currectObject().endY=b[c].endY):"arrow2"===b[c].name?(drawing.shapes.push(new Arrow2(b[c].x,b[c].y,b[c].color,b[c].lineWidth,"arrow2")),drawing.currectObject().endX=b[c].endX,drawing.currectObject().endY=b[c].endY):"text_area"===b[c].name?(drawing.shapes.push(new Text_Area(b[c].x,b[c].y,b[c].color,b[c].lineWidth,"text_area")),drawing.currectObject().fontSize=b[c].fontSize,drawing.currectObject().fontName=b[c].fontName,drawing.currectObject().fontType=b[c].fontType,drawing.currectObject().inputText=b[c].inputText):"eraser"===b[c].name?(drawing.shapes.push(new Eraser(b[c].x,b[c].y,b[c].color,b[c].lineWidth,"eraser")),drawing.currectObject().width=b[c].width,drawing.currectObject().height=b[c].height):null!==b[c].cords&&(drawing.shapes.push(new Pen(b[c].x,b[c].y,b[c].color,b[c].lineWidth)),drawing.currectObject().endX=b[c].endX,drawing.currectObject().endY=b[c].endY,drawing.currectObject().cords=b[c].cords),drawing.drawAllShapes()},error:function(){}}),$("#listBoxContainer").hide()})});